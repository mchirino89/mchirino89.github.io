name: Auto-merge Vulnerability PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # Also trigger on workflow_run completion to check after CI passes
  workflow_run:
    workflows: ["Ruby", "CodeQL"]
    types:
      - completed

# Need write permissions to approve and merge PRs
permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run for Dependabot PRs with security label
    if: |
      github.actor == 'dependabot[bot]' &&
      (github.event.pull_request.labels.*.name contains 'security' ||
       contains(github.event.pull_request.title, 'security') ||
       contains(github.event.pull_request.title, 'vulnerability') ||
       contains(github.event.pull_request.body, 'security') ||
       contains(github.event.pull_request.body, 'vulnerability'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check PR details
        id: pr-check
        run: |
          echo "PR #${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Author: ${{ github.actor }}"

      - name: Wait for CI checks
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-regexp: '.*'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          # Allow success, skipped, or neutral checks
          allowed-conclusions: success,skipped,neutral

      - name: Auto-approve PR
        if: success()
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: success()
        run: >
          gh pr merge --auto --squash
          "${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Alternative job for workflow_run events
  auto-merge-on-check-complete:
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get PR number
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: >
                `${context.repo.owner}:` +
                `${context.payload.workflow_run.head_branch}`
            });

            if (pulls.data.length === 0) {
              console.log('No open PR found for this branch');
              return null;
            }

            const pr = pulls.data[0];
            console.log(`Found PR #${pr.number}`);

            // Check if it's from Dependabot and has security labels
            const isDependabot = pr.user.login === 'dependabot[bot]';
            const hasSecurityLabel = pr.labels.some(label =>
              label.name === 'security' ||
              label.name === 'dependencies'
            );
            const hasSecurityInTitle =
              pr.title.toLowerCase().includes('security') ||
              pr.title.toLowerCase().includes('vulnerability');

            if (isDependabot && (hasSecurityLabel || hasSecurityInTitle)) {
              return pr.number;
            }

            return null;
          result-encoding: string

      - name: Auto-approve and merge
        if: steps.get-pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.get-pr.outputs.result }}');

            // Approve the PR
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: 'APPROVE',
              body: 'Auto-approving vulnerability fix PR from Dependabot'
            });

            // Merge the PR
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: 'Auto-merge: Vulnerability fix from Dependabot'
              });
              console.log(`Successfully merged PR #${prNumber}`);
            } catch (error) {
              console.log(`Failed to merge: ${error.message}`);
              // Don't fail the workflow if merge fails
            }
